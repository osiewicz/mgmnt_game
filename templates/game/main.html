{% extends 'base.html' %} {% load static %} {% block title %}Game{% endblock %}
{% block content %}

<div class="grid-container">
  <div class="grid-item">
    <div id="game-main" class="app" onload="game_request(event, null, '{% url 'api-init-game' %}')"/>
  </div>
  <div id="myModal" class="grid-item">
    <!-- Modal content -->
    <div class="modal-content">
      <div id="modal_content"></div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script type="text/javascript">
  function game_request(event, form, targetUrl, intervalList = []) {
    let request;

    event.preventDefault();

    // Abort any pending request
    if (request) {
      request.abort();
    }

    //Define Data to be sent
    let formData = $("#" + form).serialize();

    // Fire off the request to backend
    request = $.ajax({
      headers: { "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() },
      url: targetUrl,
      type: "post",
      data: formData,
      dataType: "html",
      encode: true,
    });

    // Callback handler that will be called on success
    request.done(function (response, textStatus, jqXHR) {
      if (intervalList) clearIntervalList(intervalList);
      $("#game-main").html(response);
    });

    // Callback handler that will be called on failure
    request.fail(function (jqXHR, textStatus, errorThrown) {
      if (intervalList) clearIntervalList(intervalList);
      $("#game-main").html(errorThrown);
    });

    // Callback handler that will be called regardless
    // if the request failed or succeeded
    request.always(function () {});
  }

  function game_request_timeout(event, form, targetUrl) {
    event.preventDefault();
    var deltaTime = 1000; // 1 second
    var intervalList = randomizeResults();
    setTimeout(function () {
      game_request(event, form, targetUrl, intervalList);
    }, deltaTime);
  }

  function check_project_amount(lower_limit, upper_limit) {
    let amount_of_checked = 0;
    $("[name='fields[]']").each(function () {
      if (this.checked) {
        amount_of_checked++;
      }
    });
    $("#generate_revenue").prop(
      "disabled",
      amount_of_checked < lower_limit || amount_of_checked > upper_limit
    );
    $("#map").prop(
      "disabled",
      amount_of_checked < lower_limit || amount_of_checked > upper_limit
    );
    if (amount_of_checked > 0) {
      estimate_risk();
    } else {
      $("#risk").html("");
    }
  }

  function randomizeResults() {
    var itr = 0;
    var resultList = [];
    var namespace = "expectedResults";
    var valueAround, temp;
    while ($("#" + namespace + itr.toString()).length > 0) {
      temp = $("#" + namespace + itr.toString())[0];
      valueAround = parseInt(temp.innerText);
      resultList.push(randomizeOneResult(itr, valueAround));
      itr += 1;
    }
    return resultList;
  }

  function randomizeOneResult(number, expected) {
    var deltaTime = 70;
    var deltaValue = 20;
    var namespace = "realResults";
    var newId = setInterval(function () {
      var newValue = (Math.random() - 0.5) * deltaValue + expected;
      var target = $("#" + namespace + number.toString())[0];
      target.innerText = parseInt(newValue).toString();
    }, deltaTime);
    return newId;
  }

  function clearIntervalList(lista) {
    for (var itr = 0; itr < lista.length; itr++) {
      clearInterval(lista[itr]);
    }
  }
</script>
{% endblock %}
