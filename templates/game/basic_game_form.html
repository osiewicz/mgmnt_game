{% load api_filters %}

<table class="table table-bordered table-striped">
    <tr>
        <th>&nbsp;</th>
        <th>Koszt</th>
        <th>Zysk</th>
        <th>Zwrot</th>
        <th>Ryzyko</th>
        <th>&nbsp;</th>
        <th>Wynik</th>
    </tr>
    {% for itr in round_iterator %}
        <tr>
            <td >
                <button class="btn-light" onclick="load_project_graph(event, {{ itr }})">Projekt{{ itr }}</button>
            </td>
            <td>
                {{ round_data.koszty|get_at_index:forloop.counter0 }}
            </td>
            <td id="expectedResults{{ forloop.counter0 }}">
                {{ round_data.zyski|get_at_index:forloop.counter0 }}
            </td>
            <td>
                {{ round_data.zwrot|get_at_index:forloop.counter0 }}
            </td>
            <td>
                {{ round_data.ryzyko|get_at_index:forloop.counter0 }}
            </td>
            <td>
                <label>
                    <input type="checkbox"
                            onchange="check_project_amount({{ round_data.k }}, {{ round_data.m }})"
                            name="fields[]" id="{{ forloop.counter0 }}"
                            value={{ forloop.counter0 }}{% if checkboxes %}{{ checkboxes|get_at_index:forloop.counter0 }}{% endif %}>
                    P{{ forloop.counter }}
                </label>
            </td>
            <td id="realResults{{ forloop.counter0 }}">
                {% if results %}
                    {{ results|get_at_index:forloop.counter0 }}
                {% else %} --- {% endif %}
            </td>
        </tr>
    {% endfor %}
</table>
<script type="text/javascript">
  function load_project_graph(event, project_id) {
    let request;
    event.preventDefault();

    // Abort any pending request
    if (request) {
      request.abort();
    }

    //Define Data to be sent
    let formData = {
      project_id: project_id,
      round_id: $("[name='roundId']").val(),
    };

    // Fire off the request to backend
    request = $.ajax({
      headers: { "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() },
      url: "{% url 'api-show-project' %}",
      type: "post",
      data: formData,
      dataType: "html",
      encode: true,
    });

    // Get the modal
    let modal = document.getElementById("myModal");

    // Callback handler that will be called on success
    request.done(function (response, textStatus, jqXHR) {
      //console.log(response);
      modal.style.display = "block";
      $("#modal_content").html(response);
    });

    // Callback handler that will be called on failure
    request.fail(function (jqXHR, textStatus, errorThrown) {
      //console.log(jqXHR);
      //console.log(textStatus);
      //console.log(errorThrown);
      modal.style.display = "block";
      $("#modal_content").html(errorThrown);
    });

    // Callback handler that will be called regardless
    // if the request failed or succeeded
    request.always(function () {});
  }

  $(document).ready(function () {
    // Get the modal
    let modal = document.getElementById("myModal");
    // Get the <span> element that closes the modal
    let span = document.getElementsByClassName("close")[0];

    // When the user clicks on <span> (x), close the modal
    //span.onclick = function () {
    //modal.style.display = "none";
    //};

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  });
</script>
